<!DOCTYPE html>
<html>
<head>
    <style>
      circle.highlighted {
        stroke: grey;
        stroke-width: 2;
      }
    </style>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="./toolbox.js"></script>
    <script src="./data.json"></script>
    <script>
      var milestoneArr;
      data.forEach(function(dataNode, index, arr) {
        for(i = 1; i < 8; i++)
          if(dataNode["Milestone " + i])
            dataNode["Milestone " + i] = convertDate(dataNode["Milestone " + i]);
      });
      console.log(data);
      milestoneArr = createMilestoneArr(data);
      console.log(milestoneArr);
      var milestoneIntervalArr = milestoneArr.map(intervalArr => {
          return createIntervalMedian(intervalArr);
      });
      console.log(milestoneIntervalArr);
    </script>
</head>
<body>
<h1>Milestone D3 Diagram</h1>
    <svg width="10000" height="10000"></svg>
	<script>
    var yAxis = 150;
    var xStart = 70;
    const svg = d3.select("svg");
    var milestone1 = svg.append("g")
     .attr("transform", function(d, i) { return "translate(" + (0) + ", " + yAxis + ")"; })
     .attr("id","milestone1");
    svg.append("defs")
      .append("marker")
      .attr("id", "arrow-marker")
      .attr("markerWidth", 10)
      .attr("markerHeight", 10)
      .attr("refX", 8)
      .attr("refY", 5)
      .attr("orient", "auto")
      .append("polygon")
      .attr("points", "0 0, 10 5, 0 10")
      .attr("fill", "black");

    milestone1.append("circle")
      .attr("cx", xStart)
      .attr("cy", 0)
      .attr("r", 30)
      .attr("fill", "red")
      .attr("id", "circle1")
      .on("click", handleClick);

    milestone1.append("text")
      .text(function(d, i) {return "Milestone 1"})
      .attr("width", 100)
      .attr("x", xStart) // Set the x-coordinate
      .attr("y", -40)
      .attr("text-anchor", "middle");

      var milestone = svg.select("#milestone1").node();
      var oneWidth = milestone.getBoundingClientRect().width;
      var oneHeight = milestone.getBoundingClientRect().width;
      console.log("here: ", oneWidth, oneHeight);
    var group = svg.selectAll("svg g.with-arrow")
    .data(milestoneIntervalArr)
    .enter()
    .append("g")
    .attr("transform", function(d, i) { return "translate(" + (oneWidth + i * 200) + ", " + yAxis + ")"; });

    group.append("line")
    .attr("x1", 35)
    .attr("y1", 0)
    .attr("x2", 70)
    .attr("y2", 0)
    .attr("stroke", "black")
    .attr("stroke-width", 1);


    group.append("text")
    .text(function(d) {return d;})
    .attr("width", 100)
    .attr("x", 90) // Set the x-coordinate
    .attr("y", 5)
    .attr("text-anchor", "middle");


    group.append("line")
    .attr("x1", 110)
    .attr("y1", 0)
    .attr("x2", 145)
    .attr("y2", 0)
    .attr("stroke", "black")
    .attr("stroke-width", 1)
    .attr("marker-end", "url(#arrow-marker)");
    
    group.append("circle")
    .attr("cx", 190)
    .attr("cy", 0)
    .attr("r", 30)
    .attr("fill", "red")
    .attr("id", function(d, i){return "circle"+(i+2)})
    .on("click", handleClick);

    var activeCounter = 0;
    function handleClick() {
      var isActive = d3.select(this).classed("highlighted");
      console.log(isActive);
      if(isActive){
        d3.select(this).classed("highlighted", false);
        d3.select(this.parentNode).classed("highlighted", false);
        activeCounter--;
      }else if(!isActive && activeCounter < 2){
        d3.select(this).classed("highlighted", true);
        d3.select(this.parentNode).classed("highlighted", true);
        activeCounter++;
        if(activeCounter == 2){
          var highlightedCircles= d3.selectAll("circle.highlighted").nodes();
          var indices = highlightedCircles.map(circle => d3.selectAll("circle").nodes().indexOf(circle));
          var specifiedIntervalArr = createIntervalArray("Milestone " + (indices[0] + 1), "Milestone " + (indices[1] + 1), data);
          var specifiedIntervalMedian = createIntervalMedian(specifiedIntervalArr);
          var selectedCircles = d3.selectAll("circle.highlighted").nodes();
          var selectedGroups = d3.selectAll("g.highlighted").nodes();
          console.log(selectedGroups[0].getBoundingClientRect().x);
          svg.append("line")
          .attr("class", "highlighted-line")
          .attr("x1", +selectedCircles[0].getAttribute("cx") - +selectedCircles[0].getAttribute("r") + (+selectedGroups[0].getBoundingClientRect().x) - 10)
          .attr("y1", yAxis)
          .attr("x2", +selectedCircles[1].getAttribute("cx") - +selectedCircles[1].getAttribute("r") + (+selectedGroups[1].getBoundingClientRect().x) - 10)
          .attr("y2", yAxis)
          .attr("stroke", "black")
          .attr("stroke-width", 1);
          console.log(selectedCircles);
          console.log(selectedGroups);
        }
      }else if(activeCounter == 2){
        d3.selectAll("circle.highlighted").classed("highlighted", false);
        d3.selectAll("g.highlighted").classed("highlighted", false);
        d3.select(this).classed("highlighted", true);
        d3.select(this.parentNode).classed("highlighted", true);
        activeCounter = 1;
      }
      console.log(activeCounter);

    }

    group.append("text")
    .text(function(d, i) {return "Milestone " + (i + 2)})
    .attr("width", 100)
    .attr("x", 190) // Set the x-coordinate
    .attr("y", -40)
    .attr("text-anchor", "middle");


  </script>
	
</body>
</html>
